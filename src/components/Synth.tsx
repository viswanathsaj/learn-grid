import type { NextComponentType } from 'next'
import Head from 'next/head'
import { listen, sleep, getInfo, noteMode, playNote, noteConfig } from '@utils/midi'
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger
} from '@components/ui/DropdownMenu'
import { Scale, Key, Note } from 'tonal'
import { cn } from '../utils/utils'

const controller = {
  overlaps: [1, 2, 3, 4, 5],
  scales: [
    'major',
    'minor',
    'dorian',
    'phrygian',
    'mixolydian',
    'melodic Minor',
    'harmonic Minor',
    'beBop',
    'blues Scale',
    'minor Pentatonic',
    'hungarian Minor',
    'ukranian Dorian Mode',
    'marva',
    'todi',
    'whole Tone Scale',
    'hirajoshi'
  ],
  roots: ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B']
}

function getPadMeta(root: string, scale: string) {
  const sortedNotes = (root: string) => {
    const arr1 = controller.roots.slice(0, controller.roots.indexOf(root))
    const arr2 = controller.roots.slice(controller.roots.indexOf(root)).concat(arr1)
    console.log(arr2)
    return arr2
  }

  const makeRepeated = (arr: string[], repeats: number) => Array.from({ length: repeats }, () => arr).flat()

  const padNotes = makeRepeated(sortedNotes(root), 5).concat(sortedNotes(root).slice(0, 4))

  interface padsType {
    note: string
    highlighted: boolean
  }

  const pads: padsType[] = []

  console.log(padNotes)

  padNotes.map((note) => {
    const pad = {
      note: note,
      highlighted: Scale.get(`${root} ${scale}`).notes.includes(note)
    }
    pads.push(pad)
  })

  const padsOverlapped: padsType[] = []

  let pad = 0

  while (padsOverlapped.length < 64) {
    for (let i = 0; i < 5; i++) {
      padsOverlapped.push(pads[pad]!)
      pad++
    }
    pads.slice(pad, pad + 3).map((e) => {
      padsOverlapped.push(e)
    })
  }

  return padsOverlapped
}

const Synth: NextComponentType = () => {
  return (
    <>
      <Head>
        <title>Learn Grid</title>
        <meta name='description' content='Generated by create-t3-app' />
        <link rel='icon' href='/favicon.ico' />
      </Head>
      <main className='items-center justify-center'>
        <div className='container flex flex-col items-center justify-center'>
          <button onClick={() => sleep()}>Sleep</button>
          <button onClick={() => listen()}>Listen</button>
          <button onClick={() => getInfo()}>Info</button>
          <button onClick={() => noteMode()}>Note Mode</button>
          <button onClick={() => playNote('C4')}>Play Note</button>
          <button onClick={() => noteConfig()}>Get Note Mode Config</button>
          <button onClick={() => getPadMeta('F', 'major')}>Execute</button>
        </div>
        <div className='m-52 flex  flex-none flex-wrap-reverse direction-reverse'>
          {getPadMeta('C', 'major').map((e, index) => {
            return (
              <div
                key={index}
                className={cn({
                  ['m-1 aspect-square w-[calc(12.5%-1rem)]']: true,
                  ['bg-purple-400']: e.highlighted,
                  ['bg-blue-400']: !e.highlighted
                })}
              >
                <p>{e.note}</p>
              </div>
            )
          })}
        </div>
      </main>
    </>
  )
}

export default Synth
